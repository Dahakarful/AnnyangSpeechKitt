<link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">

<h2>Vous avez demandé:</h2>
<font face="Roboto Mono">
    <span id="skitt-listening-text__recognized-sentence"></span>
</font>
<h2>La réponse est:</h2>
<font face="Roboto Mono">
    <span id="response"></span>
</font>
<script src="//cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>
<script src="./speechkitt.js"></script>

<script>
    var msg = new SpeechSynthesisUtterance();
    var voices = window.speechSynthesis.getVoices();
    msg.voice = voices[2]; // Note: some voices don't support altering params
    // msg.voice = voices.filter(function(voice) { return voice.name == 'Google FR Male'; })[0];
    msg.voiceURI = 'native';
    msg.volume = 1; // 0 to 1
    msg.rate = 0.8 // 0.1 to 10
    msg.pitch = 0; //0 to 2
    msg.lang = 'fr-FR';
    // msg.text = 'Bonjour, je suis wally, votre assistant bancaire personnelle';

    if (annyang) {

        annyang.debug(true);
        annyang.setLanguage("fr-FR");

        var showSold = function () {
            msg.text = 'Votre solde actuel est de 2556,54 €';
            speechSynthesis.speak(msg);
        };

        var virement = function (nombre, qui) {
            console.log(nombre);
            console.log(qui);
            msg.text = "Êtes-vous sûr de faire ce virement ?";
            speechSynthesis.speak(msg);
            var promise = new Promise(function (resolve, reject) {
                var result = annyang.addCallback('result', function (userSaid) {
                    console.log("result:" + userSaid[0]);
                    resolve(userSaid[0]);
                });
            });
            promise.then(function (value) {
                console.log(value);
                console.log("then");
                if (value.trim().toLowerCase() === "oui") {
                    msg.text = 'Votre virement de ' + nombre + ' € a bien été envoyé à ' + qui;
                    speechSynthesis.speak(msg);
                    $('#response').text('Votre virement de ' + nombre + ' € a bien été envoyé à ' + qui);
                } else {
                    msg.text = "Vous avez annulé votre virement !";
                    speechSynthesis.speak(msg);
                    $('#response').text("Vous avez annulé votre virement !");
                }
            });
        }

        var commands = {
            'wally montre-moi mon solde': showSold,
            'faire un virement de :nombre € à :qui': virement,
        };

        var tab = ['Montre-moi *', 'Bonjour'];

        // Add our commands to annyang
        annyang.addCommands(commands);

        // Start listening. You can call this here, or attach this call to an event, button, etc.
        // annyang.start();

        annyang.addCallback('soundstart', function () {
            console.log('sound detected');
        });

        annyang.addCallback('result', function () {
            console.log('sound stopped');
        });

        SpeechKITT.annyang();
        SpeechKITT.setStartCommand(annyang.start);
        SpeechKITT.setToggleLabelText("Comment puis-je vous aider ?");
        SpeechKITT.setInstructionsText("OK !");
        SpeechKITT.displayRecognizedSentence(true);
        // SpeechKITT.setSampleCommands(tab);

        // Define a stylesheet for KITT to use
        SpeechKITT.setStylesheet('//cdnjs.cloudflare.com/ajax/libs/SpeechKITT/0.3.0/themes/flat-concrete.css');

        // Render KITT's interface
        SpeechKITT.vroom();
    }

    speechSynthesis.speak(msg);
</script>